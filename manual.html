<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<script src="tools/jquery-3.1.1.min.js"></script>
	<script src="clarino.js"></script>

	<script>
	(function($, $C){
		//console.log($C);
		var $H = $C.html;

		var px = $C.css.unit.px,
			pc = $C.css.unit.pc,
			css = $C.css.keywords;

		var Settings = {
			title: $C.format('Clarino v.{0} - руководство пользователя', Clarino.version()),
			link:{
				color:{
					lo:'#00a',
					hi:'#06a'
				}
			}
		};

		$C.css.writeStylesheet({
			'h1,h2,h3,h4':{
				marginBottom:px(0)
			},
			'.manual':{
				fontFamily: 'Verdana, Arial, Sans-Serif',
				fontSize: px(14),
				' a':{
					':link':{color:Settings.link.color.lo},
					':visited':{color:Settings.link.color.lo},
					':hover':{color:Settings.link.color.hi}
				},
				' .navbar':{
					backgroundColor: '#eee',
					padding: px(3, 50),
					margin: px(0, 0, 20, 0)
				},
				' .code':{
					backgroundColor: '#ccc',
					width:px(300)
				},
				' .pnlErrorsDetected':{
					display: css.none,
					backgroundColor: '#ffc',
					padding: px(10),
					fontWeight: css.bold,
					border: px(1)+' solid #f00'
				},
				' .success':{color:'#080'},
				' .error':{color:'#e00'}
			}
		});

		var uid = (function(){
			var counter = 1;
			return function(){
				return counter++;
			};
		})();

		function section(level, title, content){with($H){
			return div({'class':'section'},
				a({name:'s'+uid()}),
				$H['h'+level]({'class':'title'}, title),
				div({'class':'navbar'},
					a({'href':'#toc'}, 'К оглавлению')
				),
				content
			);
		}}
		function codesample(lines){with($H){with($C){
			return pre({'class':'code'},
				lines instanceof Array?apply(lines, function(ln){return escape(ln)+'\n';})
					:escape(lines)
			);
		}}}

		var errorsDetected = false,
			errors = [];
		function assert(val, expected){
			if(val!=expected){
				errorsDetected = true;
				errors.push('Assertion failed: expected "'+$C.escape(expected)+'", but was "'+$C.escape(val)+'"');
			}
		}

		function test(action){with($H){
			errors = [];
			action();
			return errors.length?div({'class':'error'}, $C.apply(errors, function(e){return div(e)}))
				:div({'class':'success'}, 'test performed');
		}}

		var describedFields = {};

		function referenceManual(prefix, root, doc, showRemaining){with($H){with($C){
			if(typeof(doc)=='function') doc = doc();
			return table({border:1, cellpadding:3, cellspacing:0, width:pc(100)},
				$C.apply(doc, function(man, fld){
					describedFields[prefix+'.'+fld] = true;
					return tr(
						td(root[fld]?null:(errorsDetected=true,div({'class':'error'}, 'not defined')), prefix, '.', fld),
						td(man)
					);
				}),
				showRemaining?$C.apply(root, function(v, fld){
					return describedFields[prefix+'.'+fld]?null:tr(
						td(prefix, '.', fld),
						td((errorsDetected=true,div({'class':'error'}, 'нет описания')))
					);
				}):null
			);
		}}}

		function manual(){with($H){
			var markup = $C.markup;
			return div({'class':'manual'},
				h1(Settings.title),
				div({'class':'error pnlErrorsDetected'}, 'Обнаружены ошибки'),
				a({name:'toc'}),
				div({'class':'pnlToc'}),
				section(2, 'Назначение', div(
					p('Программный модуль Clarino предназначен для формирования фрагментов HTML-, XML-, и CSS-кода.')
				)),
				section(2, 'Подключение', div(
					p('Для использования библиотеки Clarino достаточно подключить её к веб-странице:'),
					codesample(['<scr'+'ipt src="clarino.js"></sc'+'ript>']),
					p('Получение номера версии:'),
					codesample(['Clarino.version()']),
					p('Доступ к интерфейсу заданной версии:'),
					codesample('Clarino.version("1.0.0")'),
					test(function(){
						assert($H.div('abc'), '<div>abc</div>');
					}),
					test(function(){
						assert($H.a({href:'#'}, 'xx'), '<a href="#">xx</a>');
					})
				)),
				section(2, 'Справочник', markup(
					section(3, 'Разделы', div(
						referenceManual('Clarino', $C, { 
							html: markup('Содержит определения HTML-тегов'),
							css: markup('Содержит функции для формирования CSS-таблиц')
						})
					)),
					section(3, 'HTML-теги', div(
						referenceManual('Clarino.html', $H, function(){
							// https://www.w3schools.com/tags/
							var tags = 'a;abbr;address;area;article;aside;audio;b;base;bdi;bdo;blockquote;body;br;button;canvas;caption;cite;code;col;colgroup;datalist;dd;del;details;dfn;dialog;div;dl;dt;em;embed;fieldset;figcaption;figure;footer;form;h1;h2;h3;h4;h5;h6;head;header;hr;html;i;iframe;img;input;ins;kbd;keygen;label;legend;li;link;main;map;mark;menu;menuitem;meta;meter;nav;nobr;noscript;object;ol;optgroup;option;output;p;param;picture;pre;progress;q;rp;rt;ruby;s;samp;script;section;select;small;source;span;strong;style;sub;summary;sup;svg;table;tbody;td;textarea;tfoot;th;thead;time;title;tr;track;u;ul;var;video;wbr'.split(';');
							var tagDefs = {};
							for(var t,i=0; t=tags[i],i<tags.length; i++){
								tagDefs[t] = $C.escape('Формирует HTML-тег <'+t+'>');
							}
							return tagDefs;
						})
					)),
					section(3, 'Управление', div(
						referenceManual('Clarino', $C, {
							apply: markup('Применяет шаблон к элементам массива или полям объекта'),
							repeat: markup('Применяет шаблон указанное число раз'),
							markup: markup('Контейнер для произвольного набора тегов, не формирующий для них родительский тег.')
						})
					)),
					section(3, 'Настройка', div(
						referenceManual('Clarino', $C, {
							version: markup('Возвращает текущую версию модуля или интерфейс для заданной версии'),
							xhtmlMode: markup('Включает режим форматирования XHTML')
						})
					)),
					section(3, 'Форматирование', div(
						referenceManual('Clarino', $C, {
							tag: markup('Создает фрагмент разметки с произвольным тегом'),
							style: markup('Форматирует строку стилей в атрибутах HTML-элемента'),
							format: markup('Форматирование строки со вставкой значений'),
							escape: markup('Заменяет символы, не допустимые в HTML- или XML-разметке на соответствующие сущности (entity)'),
							callFunction: markup('Формирует строку вызова функции для привязки обработчика события к HTML-элементу'),
							json: markup('Сериализует заданный объект в строку JSON')
						})
					)),
					section(3, 'Объявления', div(
						referenceManual('Clarino', $C, {
							defineTags: markup('Создает набор определений тегов'),
							getTagDefinitions: markup('Создает набор определений тегов'),
							symbols: markup('Создает структуру для хранения строковых констант')
						})
					)),
					section(3, 'CSS', div(
						referenceManual('Clarino.css', $C.css, {
							// writeStylesheet: false,
							// writeRules: false,
							// rules: false,
							// attributes: false,
							// stylesheet: false,
							// writeStylesheet: false,
							// unit: false,
							// keywords: false
						})
					)),
					referenceManual('Clarino', $C, {}, true),
					referenceManual('Clarino.html', $H, {}, true),
					referenceManual('Clarino.css', $C.css, {}, true),
				))
			);
		}}

		function buildToc(root){with($H){
			root = root || $('.manual');
			function tocLevel(root){
				var sections = root.find('>.section').toArray();
				if(!sections.length) return;
				return ul(
					$C.apply(sections, function(sct){sct=$(sct);
						var sctID = sct.find('a').attr('name'),
							sctTitle = sct.find('.title').html();
						return li(
							a({href:'#'+sctID}, sctTitle),
							tocLevel(sct)
						);
					})
				);
			}
			$('.pnlToc').html(tocLevel(root));
		}}


		$(function(){
			$('head title').html(Settings.title);
			$('body').html(manual());
			buildToc();
			if(errorsDetected) $('.pnlErrorsDetected').show();
		});
	})(jQuery, Clarino.version('1.0.0'));
	</script>
</head>
<body></body>
</html>
